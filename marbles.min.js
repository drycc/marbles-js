var Marbles={VERSION:"0.0.5"};!function(){"use strict";var t=function(t,e,i){for(var r=i.override,s=0,n=e.length;n>s;s++){var a=e[s];for(var o in a)if(a.hasOwnProperty(o)){if(r===!1)continue;t[o]=a[o]}}return t};Marbles.Utils={extend:function(e){var i=Array.prototype.slice.call(arguments,1);return t(e,i,{override:!0})},lazyExtend:function(e){var i=Array.prototype.slice.call(arguments,1);return t(e,i,{override:!1})},assertEqual:function(t,e){if(typeof t!=typeof e)return!1;if("object"!=typeof t)return t===e;if(Array.isArray(t)){if(!Array.isArray(e))return!1;if(t.length!==e.length)return!1;for(var i=0,r=t.length;r>i;i++)if(!this.assertInstanceIdsEqual(t[i],e[i]))return!1;return!0}for(var s in t)if(t.hasOwnProperty(s)&&t[s]!==e[s])return!1;for(s in e)if(e.hasOwnProperty(s)&&e[s]!==t[s])return!1;return!0},inheritPrototype:function(t,e){function i(){this.constructor=t}return Marbles.Utils.extend(t,e),i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},createClass:function(t){var e,i,r,s,n,a,o=t.willInitialize,h=t.didInitialize;a={didExtendCtor:[],didExtendProto:[],willInitialize:[],didInitialize:[]},t.hasOwnProperty("willInitialize")&&delete t.willInitialize,t.hasOwnProperty("didInitialize")&&delete t.didInitialize;var c=o;o=function(){var t=arguments;return a.willInitialize.forEach(function(e){e.apply(this,t)}.bind(this)),c?c.apply(this,t):void 0};var l=h;if(h=function(){var t=arguments;a.didInitialize.forEach(function(e){e.apply(this,t)}.bind(this)),l&&l.apply(this,t)},t.hasOwnProperty("parentClass")){var u=t.parentClass;delete t.parentClass,e=function(){var t=o.apply(this,arguments);return t?t:(e.__super__.constructor.apply(this,arguments),h.apply(this,arguments),this)},Marbles.Utils.inheritPrototype(e,u)}else e=function(){if("function"==typeof o){var t=o.apply(this,arguments);if(t&&t.constructor===e)return t}return"function"==typeof h&&h.apply(this,arguments),this};t.hasOwnProperty("displayName")&&(e.displayName=t.displayName,delete t.displayName);var d=[];t.hasOwnProperty("mixins")&&(d=t.mixins,delete t.mixins),e.createClass=function(t){var i=Marbles.Utils.createClass(Marbles.Utils.extend({},t,{parentClass:e}));return["didExtendCtor","didExtendProto"].forEach(function(t){a[t].forEach(function(t){t(i)})}),i};for(i in t)t.hasOwnProperty(i)&&(e.prototype[i]=t[i]);for(r=0,s=d.length;s>r;r++)n=d[r],n.hasOwnProperty("ctor")||n.hasOwnProperty("proto")?(n.hasOwnProperty("ctor")&&(Marbles.Utils.extend(e,n.ctor),"function"==typeof n.didExtendCtor&&(a.didExtendCtor.push(n.didExtendCtor),n.didExtendCtor(e))),n.hasOwnProperty("proto")&&(Marbles.Utils.extend(e.prototype,n.proto),"function"==typeof n.didExtendProto&&(a.didExtendCtor.push(n.didExtendProto),n.didExtendProto(e))),"function"==typeof n.willInitialize&&a.willInitialize.push(n.willInitialize),"function"==typeof n.didInitialize&&a.didInitialize.push(n.didInitialize)):Marbles.Utils.extend(e.prototype,n);return e}}}(),function(){"use strict";var t=[];Marbles.Dispatcher={register:function(e){t.push(e);var i=t.length-1;return i},dispatch:function(e){var i=t.map(function(t){return new Promise(function(i){i(t(e))})});return Promise.all(i)}}}(),function(){"use strict";Marbles.State={addChangeListener:function(t){this.__changeListeners.push(t)},removeChangeListener:function(t){this.__changeListeners=this.__changeListeners.filter(function(e){return e!==t})},setState:function(t){this.willUpdate();var e=this.state;Object.keys(t).forEach(function(i){e[i]=t[i]}),this.handleChange(),this.didUpdate()},replaceState:function(t){this.willUpdate(),this.state=t,this.handleChange(),this.didUpdate()},handleChange:function(){this.__changeListeners.forEach(function(t){t()})},willUpdate:function(){},didUpdate:function(){}}}(),function(){"use strict";function t(t){if("object"!=typeof t||Array.isArray(t))return JSON.stringify(t);var e=Object.keys(t),i=e.map(function(e){return t[e]});return JSON.stringify(e.sort().concat(i.sort()))}var e=Marbles.Store=function(t){this.id=t,this.constructor.__trackInstance(this),this.__changeListeners=[],this.willInitialize.apply(this,Array.prototype.slice.call(arguments,1)),this.state=this.getInitialState(),this.didInitialize.apply(this,Array.prototype.slice.call(arguments,1))};e.displayName="Marbles.Store",Marbles.Utils.extend(e.prototype,Marbles.State,{getInitialState:function(){return{}},willInitialize:function(){},didInitialize:function(){},didBecomeActive:function(){},didBecomeInactive:function(){},handleEvent:function(){}}),e.prototype.addChangeListener=function(){this.__changeListenerExpected=!1,Marbles.State.addChangeListener.apply(this,arguments),this.__active||1!==this.__changeListeners.length||(this.__active=!0,this.didBecomeActive())},e.prototype.removeChangeListener=function(){Marbles.State.removeChangeListener.apply(this,arguments),0!==this.__changeListeners.length||this.__changeListenerExpected||(this.__active=!1,this.didBecomeInactive())},e.prototype.expectChangeListener=function(){this.__changeListenerExpected=!0},e.__instances={},e.__getInstance=function(e){var i=t(e);return this.__instances[i]||new this(e)},e.__trackInstance=function(e){var i=t(e.id);this.__instances[i]=e},e.discardInstance=function(e){var i=t(e.id);delete this.__instances[i]},e.addChangeListener=function(t){var e=this.__getInstance(t);return e.addChangeListener.apply(e,Array.prototype.slice.call(arguments,1))},e.removeChangeListener=function(t){var e=this.__getInstance(t);return e.removeChangeListener.apply(e,Array.prototype.slice.call(arguments,1))},e.expectChangeListener=function(t){var e=this.__getInstance(t,{allowNull:!0});e&&e.expectChangeListener()},e.dispatcherIndex=null,e.registerWithDispatcher=function(t){this.dispatcherIndex=t.register(function(t){if(!t.storeId||this.isValidId&&!this.isValidId(t.storeId))return Promise.all(Object.keys(this.__instances).sort().map(function(e){var i=this.__instances[e];return new Promise(function(e){e(i.handleEvent(t))})}.bind(this)));var e=this.__getInstance(t.storeId);return Promise.resolve(e.handleEvent(t))}.bind(this))},e.createClass=function(t){function e(t,e){var i=this.__getInstance(e);return i[t].apply(i,Array.prototype.slice.call(arguments,2))}var i=this,r=Marbles.Utils.inheritPrototype(function(){i.apply(this,arguments)},i);r.__instances={},t.hasOwnProperty("displayName")&&(r.displayName=t.displayName,delete t.displayName),Marbles.Utils.extend(r.prototype,t);for(var s in t)t.hasOwnProperty(s)&&"_"!==s.slice(0,1)&&"function"==typeof t[s]&&(r[s]=e.bind(r,s));return r}}(),function(){"use strict";function t(t){t.__events||(t.__events={})}var e=/\s+/;Marbles.Events={on:function(i,r,s,n){t(this),Array.isArray(i)||(i=i.split(e));for(var a,o=0,h=i.length;h>o;o++)a=i[o],this.__events[a]||(this.__events[a]=[]),this.__events[a].push({callback:r,context:s||this,options:n||{}});return this},once:function(t,i,r,s){Array.isArray(t)||(t=t.split(e));for(var n=function(t){var e=function(){this.off(t,e,this),i.apply(r,arguments)};this.on(t,e,this,s)}.bind(this),a=0,o=t.length;o>a;a++)n(t[a]);return this},off:function(t,i,r){if(0===arguments.length)return this.hasOwnProperty("__events")&&delete this.__events,this;if(Array.isArray(t)||(t=t.split(e)),!this.__events)return this;var s,n,a,o,h=function(t){return r&&r!==t.context?!0:i&&i!==t.callback?!0:!1};for(n=0,a=t.length;a>n;n++)s=t[n],void 0!==i||void 0!==r?(o=this.__events[s],o&&(this.__events[s]=Array.prototype.filter.call(o,h))):this.__events.hasOwnProperty(s)&&delete this.__events[s];return this},trigger:function(t){var i=Array.prototype.slice.call(arguments,1);if(Array.isArray(t)||(t=t.split(e)),!this.__events)return this;var r,s,n,a,o,h;for(n=0,o=t.length;o>n;n++)if(r=this.__events[t[n]])for(a=0,h=r.length;h>a;a++)s=r[a],s.options.args===!1?s.callback.call(s.context):s.callback.apply(s.context,i);return this}}}(),function(){"use strict";Marbles.QueryParams={deserializeParams:function(t){t="?"===t.substr(0,1)?t.substring(1).split("&"):t.split("&");for(var e=[{}],i=0,r=t.length;r>i;i++){var s=t[i].split("="),n=decodeURIComponent(s[0]),a=decodeURIComponent(s[1]||"").replace("+"," ").trim();if("string"!=typeof a||a){-1!==a.indexOf(",")&&(a=a.split(","));for(var o=0,h=e.length;h>o;o++){if(!e[o].hasOwnProperty(n)){e[o][n]=a;break}o===h-1&&(e.push({}),h++)}}}return e},combineParams:function(t){function e(e,i){for(var r=0,s=t.length;s>r;r++){if(!t[r].hasOwnProperty(e)){t[r][e]=i;break}r===s-1&&(t.push({}),s++)}}for(var i,r=Array.prototype.slice.call(arguments,1),s=0,n=r.length;n>s;s++)for(i in r[s])r[s].hasOwnProperty(i)&&e(i,r[s][i]);return t},replaceParams:function(t){function e(e,i,r){t[e]=t[e]||{},t[e][i]=r}for(var i,r=Array.prototype.slice.call(arguments,1),s=0,n=r.length;n>s;s++)for(i in r[s])r[s].hasOwnProperty(i)&&e(s,i,r[s][i]);return t},serializeParams:function(t){for(var e=[],i=0,r=t.length;r>i;i++)for(var s in t[i])if(t[i].hasOwnProperty(s)){var n=t[i][s];if("string"==typeof n&&!n||void 0===n||null===n)continue;"object"==typeof n&&n.hasOwnProperty("length")&&(n=n.join(",")),e.push(encodeURIComponent(s)+"="+encodeURIComponent(n))}return"?"+e.join("&")}}}(),function(){"use strict";var t=Marbles.Utils.createClass({displayName:"Marbles.History",mixins:[Marbles.QueryParams],willInitialize:function(){this.started=!1,this.handlers=[],this.options={},this.path=null,this.prevPath=null,this.handlePopState=this.handlePopState.bind(this)},route:function(t,e,i,r){if("function"!=typeof i)throw new Error(this.constructor.displayName+".prototype.route(): callback is not a function: "+JSON.stringify(i));if("function"!=typeof t.test)throw new Error(this.constructor.displayName+".prototype.route(): expected route to be a RegExp: "+JSON.stringify(t));this.handlers.push({route:t,name:e,callback:i,opts:r})},navigate:function(t,e){if(Marbles.history!==this||!this.started)throw new Error("Marbles.history has not been started or is set to a different instance");if(e||(e={}),e.hasOwnProperty("trigger")||(e.trigger=!0),e.hasOwnProperty("replace")||(e.replace=!1),e.hasOwnProperty("force")||(e.force=!1),"/"===t[0]&&(t=t.substring(1)),e.params&&(t=this.pathWithParams(t,e.params)),t!==this.path||e.force){if(t=this.pathWithRoot(t),!this.options.pushState)return window.location.href=t,void 0;var i="pushState";e.replace&&(i="replaceState"),window.history[i]({},document.title,t),e.trigger&&this.loadURL()}},pathWithParams:function(t,e){if(0===e.length)return t;e=[].concat(e),e[0]=Marbles.Utils.extend({},e[0]),t=t.replace(/:([^\/]+)/g,function(t,i){var r=e[0];if(r.hasOwnProperty(i)){var s=r[i];return delete r[i],encodeURIComponent(s)}return":"+i});var i=this.serializeParams(e);return i.length>1&&(-1!==t.indexOf("?")?t=t+"&"+i.substring(1):t+=i),t},pathWithRoot:function(t){var e=this.options.root;return e&&t.substr(0,e.length)!==e&&("/"!==e.substring(e.length-1)&&"/"!==t.substr(0,1)&&(t="/"+t),t=e+t),t},getURLFromPath:function(t,e){return e&&0!==e.length&&(t=this.pathWithParams(t,e)),window.location.protocol+"//"+window.location.host+this.pathWithRoot(t)},start:function(t){if(Marbles.history&&Marbles.history.started)throw new Error("Marbles.history has already been started");t||(t={}),t.hasOwnProperty("trigger")||(t.trigger=!0),Marbles.history||(Marbles.history=this),this.dispatcher=t.dispatcher||Marbles.Dispatcher,this.options=Marbles.Utils.extend({root:"/",pushState:!0},t),this.path=this.getPath(),this.options.pushState&&(this.options.pushState=!(!window.history||!window.history.pushState)),this.options.pushState&&window.addEventListener("popstate",this.handlePopState,!1),this.started=!0,this.trigger("start"),t.trigger&&this.loadURL()},stop:function(){this.options.pushState&&window.removeEventListener("popstate",this.handlePopState,!1),this.started=!1,this.trigger("stop")},getPath:function(){var t=window.location.pathname;window.location.search&&(t+=window.location.search);var e=this.options.root.replace(/([^\/])\/$/,"$1");return-1!==t.indexOf(e)&&(t=t.substr(e.length)),t.replace(this.constructor.regex.routeStripper,"")},handlePopState:function(){this.checkURL()},checkURL:function(){var t=this.getPath();t!==this.path&&this.loadURL()},getHandler:function(t){t=t||this.getPath();for(var e=null,i=0,r=this.handlers.length;r>i;i++)if(this.handlers[i].route.test(t)){e=this.handlers[i];break}return e},loadURL:function(){this.prevPath=this.path;var t=this.path=this.getPath(),e=t.match(this.constructor.regex.routeParts);t=e[1];var i=this.deserializeParams(e[2]||""),r=this.getHandler(t);if(r){var s=!1;this.trigger("handler:before",{handler:r,path:t,params:i,abort:function(){s=!0}}),s||(r.callback(t,i),this.trigger("handler:after",{handler:r,path:t,params:i}))}return r},trigger:function(t,e){return this.dispatcher.dispatch(Marbles.Utils.extend({source:"Marbles.History",name:t},e))}});Marbles.History=t,t.regex={routeStripper:/^[\/]/,routeParts:/^([^?]*)(?:\?(.*))?$/},t.start=function(){return Marbles.history||(Marbles.history=new Marbles.History),Marbles.history.start.apply(Marbles.history,arguments)}}(),function(){"use strict";var t=Marbles.Utils.createClass({displayName:"Marbles.Router",willInitialize:function(){this.bindRoutes()},navigate:function(t,e){return Marbles.history.navigate(t,e)},route:function(t,e,i){Marbles.history||(Marbles.history=new Marbles.History);var r=[];"function"!=typeof t.test&&(r=this.routeParamNames(t),t=this.routeToRegExp(t));var s;"function"==typeof e?s=e.name||e.displayName||null:(s=e,e=this[e]),Marbles.history.route(t,s,function(s,n){return n=Marbles.QueryParams.combineParams(n,this.extractNamedParams(t,s,r)),e.apply(this,[n,i]),this}.bind(this),i)},bindRoutes:function(){var t=this.constructor;if(!t.routes)throw new Error("You need to define "+t.displayName||t.name+".routes");for(var e,i,r=0,s=t.routes,n=s.length;n>r;r++){e={};for(i in s[r])s[r].hasOwnProperty(i)&&"path"!==i&&"handler"!==i&&(e[i]=s[r][i]);this.route(s[r].path,s[r].handler,e)}},routeToRegExp:function(t){"/"===t[0]&&(t=t.substring(1));var e=this.constructor;return t=t.replace(e.regex.escape,"\\$&").replace(e.regex.namedParam,"([^/]+)").replace(e.regex.splatParam,"(.*?)"),new RegExp("^"+t+"$")},routeParamNames:function(t){var e=this.constructor,i=[],r=t.match(e.regex.namedParam);if(r&&r.length)for(var s=0,n=r.length;n>s;s++)i.push(r[s].slice(1));if(r=t.match(e.regex.splatParam),r&&r.length)for(s=0,n=r.length;n>s;s++)i.push("splat"+(s>0?s+1:""));return i},extractNamedParams:function(t,e,i){for(var r=[],s={},n=0,a=this.extractParams(t,e),o=a.length;o>n;n++)r.push(decodeURIComponent(a[n]));for(n=0,o=i.length;o>n;n++)s[i[n]]=r[n];return s},extractParams:function(t,e){return t.exec(e).slice(1)}});Marbles.Router=t,t.regex={namedParam:/:\w+/g,splatParam:/\*\w*/g,escape:/[-[\]{}()+?.,\\^$|#\s]/g},t.routes=[],t.createClass=function(t){t.hasOwnProperty("displayName")||(t.displayName=this.displayName);var e=this.routes;t.hasOwnProperty("routes")&&(e=t.routes,delete t.routes),t.parentClass=this;var i=Marbles.Utils.createClass(t);return i.routes=e,i}}(),function(){"use strict";function t(t,i){i=i||{};var r;return r=i.hasOwnProperty("keypath")&&i.keypath!==!0?[t]:t.split(e)}var e=".",i="Marbles.Accessors";Marbles.Accessors={set:function(e,i,r){var s,n,a,o=t(e,r),h=o.pop(),c=this;for(n=0,a=o.length;a>n;n++)s=o[n],c[s]=c[s]||{},c=c[s];var l=c[h];c[h]=i,(r||{}).silent!==!0&&i!==l&&"function"==typeof this.trigger&&(this.trigger("change",i,l,e,r),this.trigger("change:"+e,i,l,e,r))},get:function(e,i){var r,s,n,a=t(e,i),o=a.pop(),h=this;for(s=0,n=a.length;n>s&&h;s++)r=a[s],h=h[r];return h&&h.hasOwnProperty(o)?h[o]:void 0},remove:function(r,s){if(this.hasKey(r,s)){var n=t(r,s),a=n.pop(),o=this;if(n.length&&(o=this.get(n.join(e))),!o)throw new Error(i+"("+this.constructor.displayName+"): Can't remove property "+JSON.stringify(a)+" from undefined keypath: "+n.join(e));var h=o[a];o.hasOwnProperty(a)&&delete o[a],(s||{}).silent!==!0&&void 0!==h&&"function"==typeof this.trigger&&(this.trigger("change",void 0,h,r,s),this.trigger("change:"+r,void 0,h,r,s))}},hasKey:function(i,r){var s=t(i,r),n=s.pop(),a=this.get(s.join(e));return a&&a.hasOwnProperty(n)?!0:!1}}}(),function(){"use strict";Marbles.Transaction={transaction:function(t){var e=Object.create(this),i=[];e.trigger=function(){i.push(arguments)};var r=!1;return e.abortTransaction=function(){r=!0},e.finalizeTransaction=function(){if(!r){delete e.trigger,delete e.abortTransaction,delete e.finalizeTransaction;for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);for(var s,n=0,a=i.length;a>n;n++)s=i.shift(),this.trigger.apply(this,s)}}.bind(this),arguments.length>0?(t.call(e,e),e.finalizeTransaction(),void 0):e},abortTransaction:function(){throw new Error("Must be inside a transaction to abort one.")},finalizeTransaction:function(){throw new Error("Must be inside a transaction to finalize one.")}}}(),function(){"use strict";var t=function(e,i){if(e===i)return!0;if(typeof e!=typeof i)return!1;if(!e||!i)return!1;if("object"==typeof e){for(var r in e)if(e.hasOwnProperty(r)&&!t(e[r],i[r]))return!1;for(r in i)if(i.hasOwnProperty(r)&&!t(i[r],e[r]))return!1;return!0}return e===i},e=function(e,i){var r=Marbles.Utils.extend({},this.__hasChanges);r[e]=t(this.__originalValues[e],i)?!1:!0,this.set("__hasChanges",r)};Marbles.DirtyTracking={willInitialize:function(){var t=this.constructor.dirtyTrackingKeypaths;if(!Array.isArray(t))throw new Error(this.constructor.displayName+": `dirtyTrackingKeypaths` property (Array) on ctor required, is "+JSON.stringify(t)+"!");this.resetDirtyTracking(),t.forEach(function(t){var i=t.split("."),r="";i.forEach(function(i){r=r?r+"."+i:i,this.on("change:"+r,function(){e.call(this,t,this.get(t))}.bind(this))}.bind(this)),this.on("change",function(i,r,s){var n,a;s!==t&&s.substr(0,t.length)===t&&(a=s.substring(t.length+1),n=this.get(t),e.call(this,t,n))}.bind(this))}.bind(this))},didInitialize:function(){this.resetDirtyTracking()},proto:{resetDirtyTracking:function(t){var e;t?e=[t]:(e=this.constructor.dirtyTrackingKeypaths,this.__originalValues={},this.__hasChanges={}),e.forEach(function(t){this.__originalValues[t]=this.get(t),this.__hasChanges[t]=!1}.bind(this))},isDirty:function(t){if(t)return!!this.__hasChanges[t];for(var e in this.__hasChanges)if(this.__hasChanges.hasOwnProperty(e)&&this.isDirty(e))return!0;return!1}}}}(),function(){"use strict";var t=function(t){return t.replace(".","_")};Marbles.Validation={didInitialize:function(){var t=this.constructor.validation;if(!t)throw new Error(this.constructor.displayName+": `validation` property (Object) on ctor required, is "+JSON.stringify(t)+"!");Object.keys(t).forEach(function(t){var e=t.split("."),i="";e.forEach(function(e){i=i?i+"."+e:e,this.on("change:"+i,function(){this.performValidation(t,this.get(t))}.bind(this))}.bind(this)),this.on("change",function(e,i,r){var s,n;r!==t&&r.substr(0,t.length)===t&&(n=r.substring(t.length+1),s=this.get(t),this.performValidation(t,s))}.bind(this));var r=this.get(t);void 0!==r&&this.performValidation(t,r)}.bind(this))},proto:{performValidation:function(e,i){var r,s;e?(s=this.constructor.validation[e],r=t(e),s.call(this,i,function(t,e){this.set("validation."+r+".valid",t),this.set("validation."+r+".msg",e)}.bind(this))):Object.keys(this.constructor.validation).forEach(function(t){this.performValidation(t,this.get(t))}.bind(this))},getValidation:function(e){var i=t(e),r=this.get("validation."+i+".valid",r),s=this.get("validation."+i+".msg",s);return{valid:r,msg:s}},isValid:function(){for(var t=!0,e=this.constructor.validationRequiredKeypaths||[],i=0,r=e.length;r>i;i++)if(void 0===this.get(e[i])){t=!1;break}if(t)for(var s in this.validation)if(this.validation.hasOwnProperty(s)&&this.validation[s].valid===!1){t=!1;break}return t}}}}(),function(){"use strict";var t=Marbles.Utils.createClass({displayName:"Marbles.URI",mixins:[Marbles.QueryParams],willInitialize:function(t,e){this.url=t.trim(),this.params=e||[{}],this.parse(),this.isURI=!0},toString:function(){var t="";443!==this.port&&80!==this.port&&(t=":"+this.port);var e="";this.scheme&&(e=this.scheme+"://");var i=this.serializeParams(this.params);"?"===i&&(i="");var r="";return this.hash&&(r="#"+this.hash),(e+this.hostname+t+this.path+i+r).replace(/\/$/,"")},assertEqual:function(t){var e=t;return t.isURI!==!0&&(e=new this.constructor(t)),e.scheme===this.scheme&&e.hostname===this.hostname&&e.port===this.port&&e.path===this.path&&e.params===this.params&&e.hash===this.hash},parse:function(){var t=this.url.match(this.constructor.REGEX);if(this.hostname=t[2]||this.defaultHost(),this.scheme=(t[1]||this.defaultScheme()).replace(/:\/\/$/,""),this.port=Number(t[3])||this.defaultPort(),this.path=t[4]||"",t[5]){var e=this.deserializeParams(t[5]);this.replaceParams.apply(this,[this.params].concat(e))}this.hash=t[6]},defaultScheme:function(){return"undefined"!=typeof window?window.location.protocol+"//":this.hostname?"http://":""},defaultHost:function(){return"undefined"!=typeof window?window.location.hostname:""},defaultPort:function(){return this.hostname===this.defaultHost()&&"undefined"!=typeof window&&window.location.port?window.location.port:"https"===this.scheme?443:80}});Marbles.URI=t,t.REGEX=/^(https?:\/\/)?([^\/]+(:\d+)?)?([^\?#]+)?(\?[^#]+)?(#.+)?$/}(),function(){"use strict";Marbles.HTTP=function(e){var i=new t({method:e.method,url:e.url,params:e.params,body:e.body,headers:e.headers,middleware:e.middleware});return"function"==typeof e.callback&&i.once("complete",e.callback),i.xhr||(i.open(),i.send()),i};var t=Marbles.Utils.createClass({displayName:"Marbles.HTTPRequest",mixins:[Marbles.Events],willInitialize:function(t){if(t||(t={}),this.middleware=t.middleware||[],this.method=t.method||"GET",this.method=this.method.toUpperCase(),this.uri=new Marbles.URI(t.url,t.params||[{}]),this.requestHeaders=t.headers||{},this.requestBody=t.body||null,"GET"===this.method||"HEAD"===this.method){if(this.id=this.method+":"+this.uri.toString(),this.constructor.activeRequests[this.id])return this.constructor.activeRequests[this.id];this.on("before:send",this.trackRequest,this),this.on("complete",this.untrackRequest,this),this.on("terminated",this.untrackRequest,this)}this.on("before:send",this.callRequestMiddleware,this),this.on("before:send",this.setXMLHTTPRequestHeaders,this),this.on("before:complete",this.callResponseMiddleware,this),this.on("complete",this.untrackRequest,this),this.on("before:send",function(){var t,e;this.completePromise=new Promise(function(i,r){t=i,e=r});var i=function(e,i){this.off("terminated",r,this),this.completePromise=null,t([e,i])},r=function(t){this.off("complete",i,this),this.completePromise=null,e(t)};this.once("complete",i,this),this.once("terminated",r,this)},this),this.completePromise=null},then:function(){var t=this.completePromise||new Promise(function(t,e){e(new Error("Request not started!"))});return t.then.apply(t,arguments)},"catch":function(){var t=this.completePromise||new Promise(function(t,e){e(new Error("Request not started!"))});return t.catch.apply(t,arguments)},setRequestHeader:function(t,e){this.requestHeaders[t]=e},getRequestHeader:function(t){return this.requestHeaders[t]},getResponseHeader:function(t){return this.xhr.getResponseHeader(t)},terminate:function(t){this.terminated=!0,this.trigger("terminated",t)},resend:function(t){this.terminate(t||"resend"),this.open(),this.send()},callRequestMiddleware:function(){for(var t=0,e=this.middleware,i=e.length;i>t&&!this.terminated;t++)"function"==typeof e[t].willSendRequest&&e[t].willSendRequest(this)},callResponseMiddleware:function(){for(var t=0,e=this.middleware,i=e.length;i>t&&!this.terminated;t++)"function"==typeof e[t].didReceiveResponse&&e[t].didReceiveResponse(this)},trackRequest:function(){this.constructor.activeRequests[this.id]=this},untrackRequest:function(){this.constructor.activeRequests.hasOwnProperty(this.id)&&delete this.constructor.activeRequests[this.id]},setXMLHTTPRequest:function(){this.xhr=new XMLHttpRequest,this.xhr.onreadystatechange=this.handleReadyStateChange.bind(this)},setXMLHTTPRequestHeaders:function(){for(var t in this.requestHeaders)this.requestHeaders.hasOwnProperty(t)&&this.xhr.setRequestHeader(t,this.requestHeaders[t])},handleReadyStateChange:function(){if(4===this.xhr.readyState){this.trigger("before:complete",this.xhr);var t=this.responseData||this.xhr.response;this.xhr.status>=200&&this.xhr.status<400&&0!==this.xhr.status?this.trigger("success",t,this.xhr):this.trigger("failure",t,this.xhr),this.trigger("complete",t,this.xhr)}},open:function(){if(!this.xhr||4===this.xhr.readyState){this.setXMLHTTPRequest();var t=this.uri.toString(),e=!0;this.xhr.open(this.method,t,e),this.trigger("open",this.method,t,e)}},send:function(){if(1===this.xhr.readyState){var t=function(){if(this.trigger("before:send"),this.multipart===!0){if("function"!=typeof this.xhr.sendAsBinary)throw new Error(this.constructor.displayName+": "+this.xhr.constructor.name+".prototype.sendAsBinary is not a function!");this.xhr.sendAsBinary(this.requestBody)}else try{this.xhr.send(this.requestBody)}catch(t){setTimeout(function(){throw t},0)}this.trigger("after:send")}.bind(this);this.body&&Array.isArray(this.body)?(this.setRequestHeader("Content-Type","multipart/form-data; boundary="+this.constructor.MULTIPART_BOUNDARY),this.multipart=!0,this.buildMultipartRequestBody(t)):t()}},buildMultipartRequestBody:function(t){function e(t,e){var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsBinaryString(t)}function i(e){e&&a.push(e),o--,0===o&&(this.body=s,this.body+=a.join(s),this.body+=n,t())}function r(t){var r=t[0],s=t[1],n=t[2],a=['Content-Disposition: form-data; name="'+r+'"; filename="'+n+'"',"Content-Type: "+(s.type||"application/octet-stream"),"Content-Length: "+s.size].join("\r\n");e(s,function(t){a+=t+"\r\n",i(a)})}for(var s="--"+this.constructor.MULTIPART_BOUNDARY+"\r\n",n="--"+this.constructor.MULTIPART_BOUNDARY+"--",a=[],o=this.body.length,h=0,c=this.body.length;c>h;h++)r(this.body[h])}});Marbles.HTTPRequest=t,t.MULTIPART_BOUNDARY="-----------REQUEST_PART",t.activeRequests={}}(),Marbles.HTTP.Middleware=Marbles.HTTP.Middleware||{},function(){"use strict";var t="application/x-www-form-urlencoded";Marbles.HTTP.Middleware.FormEncoded={willSendRequest:function(e){if(!e.multipart&&e.requestBody){var i=e.getRequestHeader("Content-Type");if(i===t){var r=e.requestBody;Array.isArray(r)||(r=[r]),e.requestBody=Marbles.QueryParams.serializeParams(r).substring(1)}}},didReceiveResponse:function(e){var i=e.getResponseHeader("Content-Type");if(i===t){var r=e.xhr.response,s=null;r&&"string"==typeof r&&(Array.isArray(s)||(s=[s]),e.responseData=Marbles.QueryParams.deserializeParams(s))}}}}(),function(){"use strict";Marbles.HTTP.Middleware.SerializeJSON={willSendRequest:function(t){if(!t.multipart){var e=t.getRequestHeader("Content-Type");if(/\bjson/i.test(e)){var i=t.requestBody;t.requestBody=i?JSON.stringify(i):null}}},didReceiveResponse:function(t){var e=t.getResponseHeader("Content-Type");if(/\bjson/i.test(e)){var i=t.xhr.response;if(t.responseData=null,i)try{t.responseData=JSON.parse(i)}catch(r){t.terminate(r)}}}}}(),function(){"use strict";Marbles.HTTP.Middleware.WithCredentials={willSendRequest:function(t){try{t.xhr.withCredentials=!0}catch(e){setTimeout(function(){throw e},0)}}}}(),function(){"use strict";var t=/,[\s\r\n]*/,e=/<([^>]+)>((?:[\s\r\n]|.)*)/,i=/[\s\r\n]*;[\s\r\n]*/,r=/([^=]+)=['"]?([^'"]+)['"]?/;Marbles.HTTP=Marbles.HTTP||{},Marbles.HTTP.LinkHeader={parse:function(s){var n,a,o,h,c,l,u,d=[],p=s.split(t);for(n=0,a=p.length;a>n;n++)if(o=p[n].match(e)){for(h={href:o[1]},l=o[2].split(i),c=0,u=l.length;u>c;c++)o=l[c].match(r),o&&(h[o[1]]=o[2]);d.push(h)}return d}}}(),function(){"use strict";Marbles.Object=Marbles.Utils.createClass({displayName:"Marbles.Object",mixins:[Marbles.Accessors,Marbles.Events],willInitialize:function(t){this.parseAttributes(t)},parseAttributes:function(t){for(var e in t)t.hasOwnProperty(e)&&this.set(e,t[e])}})}(),function(){"use strict";var t=Marbles.Utils.createClass({displayName:"Marbles.IDCounter",willInitialize:function(t,e){e||(e=0),this.scope=t,this.count=e},incrementCounter:function(){return this.count++},nextID:function(){return this.scope+"_"+this.incrementCounter()}});Marbles.IDCounter=t,t.counterScopeMapping={},t.counterForScope=function(t){var e=this.counterScopeMapping[t];return e||(e=new this(t),this.counterScopeMapping[t]=e),e}}(),function(){"use strict";var t,e,i,r;Marbles.CIDMapping={didExtendCtor:function(e){e.instances={},e.__cidMapping={},void 0===e.cidMappingScope&&(e.cidMappingScope=[]),e.__cidName=e.cidScope?t.call(e):"_default",e.__cidCounter=new Marbles.IDCounter(e.__cidName)},ctor:{find:function(t,i){var r,s,n=e.call(this,t),a=this.__cidMapping,o=this.__cidName,h=!i||i.fetch!==!1;return i||(i={}),t.hasOwnProperty("cid")?(r=t.cid,h=!1):n&&(r=(a[o]||{})[n]),void 0!==r&&null!==r&&(s=this.instances[r])?s:(h===!0&&this.fetch(t,i),null)},findOrNew:function(t){var e=this.find(t,{fetch:!1});return e||(e=new this(t)),e},fetch:function(){throw new Error("You need to define "+this.displayName+".fetch(params, options)")},detach:function(t){var e,i,r=this.instances,s=r[t],n=this.__cidName,a=this.__cidMapping;s&&s.willDetach&&s.willDetach(),r.hasOwnProperty(t)&&delete r[t],a.hasOwnProperty(t)&&delete a[t],r[n]&&(e=r[n].indexOf(t),-1!==e&&(i=r[n],i=i.slice(0,e).concat(i.slice(e+1,i.length)),r[n]=i)),s&&(s.trigger("detach"),s.didDetach&&s.didDetach()),this.trigger("detach",t,s),this.off()}},proto:{initCIDMapping:function(){void 0===this.cid&&(this.cid=this.constructor.__cidCounter.nextID()),i.call(this)},detach:function(){this.constructor.detach(this.cid)}}},t=function(){var t,e,i=[],r=this.cidScope;for(t=0,e=r.length;e>t;t++)i.push(this[r[t]]);return i.join(":")},e=function(t){var e,i,r=[],s=this.cidMappingScope;for(e=0,i=s.length;i>e;e++){if(!t.hasOwnProperty(s[e]))return null;r.push(t[s[e]])}return r.join(":")},i=function(){var t,e,i=this.constructor,s=i.instances,n=i.cidMappingScope;for(s[this.cid]=this,t=0,e=n.length;e>t;t++)this.on("change:"+n[t],r,this)},r=function(t,e,i){var r,s,n,a,o=[],h=[],c=this.constructor,l=c.__cidMapping,u=c.__cidName;for(s=c.cidMappingScope,r=0,n=s.length;n>r;r++)s[r]===i?(o.push(e),h.push(t)):(a=this.get(s[r]),o.push(a),h.push(a));o=o.join(":"),h=h.join(":"),void 0===l[u]&&(l[u]={}),l[u][h]=this.cid,l[u].hasOwnProperty(o)&&delete l[u][o]}}(),function(){"use strict";Marbles.Model=Marbles.Utils.createClass({displayName:"Marbles.Model",mixins:[{ctor:{modelName:"model",cidScope:["modelName"],cidMappingScope:["id"],JSONKeys:"all"}},{ctor:Marbles.Events,proto:Marbles.Events},Marbles.Accessors,Marbles.Transaction,Marbles.CIDMapping],willInitialize:function(t,e){return t||(t={}),e||(e={}),e.cid&&(this.cid=e.cid),this.initCIDMapping(),this.transaction(function(){this.parseAttributes(t)}),this},parseAttributes:function(t){for(var e in t)t.hasOwnProperty(e)&&this.set(e,t[e],{keypath:!1})},toJSON:function(){var t,e,i,r,s={};for(t="all"===this.constructor.JSONKeys?Object.keys(this):this.constructor.JSONKeys,e=0,i=t.length;i>e;e++)r=t[e],this.hasOwnProperty(r)&&(s[r]=this[r]);return s}})}(),function(){"use strict";Marbles.Collection=Marbles.Utils.createClass({displayName:"Marbles.Collection",mixins:[{ctor:{collectionName:"collection",cidScope:["collectionName"],model:Marbles.Model,buildModel:function(t,e){var i=(e||{}).model||this.model,r=i.find(t,{fetch:!1});return r?r.parseAttributes(t):r=new i(t),r}}},{ctor:Marbles.Events,proto:Marbles.Events},Marbles.Accessors,Marbles.CIDMapping],willInitialize:function(t){this.modelCIDs=[],this.options={unique:!!t.unique},t.cid&&(this.cid=t.cid),this.initCIDMapping(),this.watchModelMortality(),this.on("reset prepend append remove",function(){this.trigger("change:models",this.models)},this)},watchModelMortality:function(){this.constructor.model.on("detach",function(t){this.removeCIDs([t])},this)},indexOf:function(t){return this.modelCIDs.indexOf(t.cid)},first:function(){return this.constructor.model.find({cid:this.modelCIDs[0]})},last:function(){return this.constructor.model.find({cid:this.modelCIDs[this.modelCIDs.length-1]})},forEach:function(t,e){for(var i,r=this.modelCIDs,s=0,n=r.length;n>s;s++)i=this.constructor.model.find({cid:r[s]}),i&&t.call(e||this,i,s)},models:function(){for(var t,e=this.modelCIDs,i=[],r=0,s=e.length;s>r;r++)t=this.constructor.model.find({cid:e[r]}),t&&i.push(t);return i},resetJSON:function(t,e){e||(e={}),this.modelCIDs=[];var i=this.appendJSON(t,{silent:!0});return e.silent||this.trigger("reset",i),i},resetModels:function(t,e){return e||(e={}),this.modelCIDs=[],t=this.appendModels(t,{silent:!0}),e.silent||this.trigger("reset",t),t},reset:function(t){t||(t={}),this.modelCIDs=[],t.silent||this.trigger("reset",[])},removeAtIndex:function(t){var e=this.modelCIDs[t];return this.modelCIDs=this.modelCIDs.slice(0,t).concat(this.modelCIDs.slice(t+1,this.modelCIDs.length)),this.trigger("remove",e),this.modelCIDs.length
},removeCIDs:function(t){for(var e,i=0,r=t.length;r>i;i++)e=this.modelCIDs.indexOf(t[i]),-1!==e&&this.removeAtIndex(e);return this.modelCIDs.length},remove:function(){for(var t=Array.prototype.slice.call(arguments,0),e=0,i=t.length;i>e;e++)this.removeCIDs([t[e].cid]);return this.modelCIDs.length},prependJSON:function(t,e){if(!t||!t.length)return[];e||(e={});for(var i,r=[],s=t.length-1;s>=0;s--)i=this.constructor.buildModel(t[s]),this.options.unique&&-1!==this.modelCIDs.indexOf(i.cid)||(this.modelCIDs.unshift(i.cid),r.unshift(i));return e.silent||this.trigger("prepend",r),r},prependModels:function(t,e){if(!t||!t.length)return[];e||(e={});for(var i,r=[],s=t.length-1;s>=0;s--)i=t[s],this.options.unique&&-1!==this.modelCIDs.indexOf(i.cid)||(this.modelCIDs.unshift(i.cid),r.unshift(i));return e.silent||this.trigger("prepend",r),r},prependCIDs:function(t,e){if(!t||!t.length)return[];e||(e={});for(var i,r,s=[],n=t.length;n>=0;n--)if(i=t[n],!this.options.unique||-1===this.modelCIDs.indexOf(i)){if(r=this.constructor.find({cid:i}),!r)continue;this.modelCIDs.unshift(i),s.unshift(r)}return e.silent||this.trigger("prepend",s),s},unshift:function(){return this.prependModels(Array.prototype.slice.call(arguments,0))},appendJSON:function(t,e){if(!t||!t.length)return[];e||(e={});for(var i,r=[],s=0,n=t.length;n>s;s++)i=this.constructor.buildModel(t[s]),this.options.unique&&-1!==this.modelCIDs.indexOf(i.cid)||(this.modelCIDs.push(i.cid),r.push(i));return e.silent||this.trigger("append",r),r},appendModels:function(t,e){if(!t||!t.length)return[];e||(e={});for(var i,r=[],s=0,n=t.length;n>s;s++)i=t[s],this.options.unique&&-1!==this.modelCIDs.indexOf(i.cid)||(this.modelCIDs.push(i.cid),r.push(i));return e.silent||this.trigger("append",r),r},appendCIDs:function(t,e){if(!t||!t.length)return[];e||(e={});for(var i,r,s=[],n=0,a=t.length;a>n;n++)if(i=t[n],!this.options.unique||-1===this.modelCIDs.indexOf(i)){if(r=this.constructor.find({cid:i}),!r)continue;this.modelCIDs.push(i),s.push(r)}return e.silent||this.trigger("append",s),s},push:function(){return this.appendModels(Array.prototype.slice.call(arguments,0))}})}();